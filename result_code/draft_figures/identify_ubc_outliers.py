"""
UBC Expression Outlier Detection and Visualization

This script identifies slides with abnormally low UBC expression that represent
technical failures and should be excluded from analysis.

UBC is a high-expression housekeeping gene that should show consistent strong signal.
Slides with very low UBC in BOTH regions indicate technical problems (e.g., poor
hybridization, tissue damage, processing artifacts).

Author: Generated for RNA Scope QC analysis
Date: 2025-11-16
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
import scienceplots
plt.style.use('science')
plt.rcParams['text.usetex'] = False
from pathlib import Path

# ══════════════════════════════════════════════════════════════════════════
# 1. LOAD DATA
# ══════════════════════════════════════════════════════════════════════════

# Positive control data is generated by fig_positive_control_comprehensive.py
data_path = Path(__file__).parent / "output" / "positive_control_comprehensive" / "positive_control_comprehensive_data.csv"
output_dir = Path(__file__).parent / "output" / "ubc_outlier_analysis"
output_dir.mkdir(parents=True, exist_ok=True)

df = pd.read_csv(data_path)

print("="*80)
print("UBC EXPRESSION OUTLIER DETECTION")
print("="*80)
print(f"\nLoaded {len(df)} slides with paired Cortex/Striatum data")

# ══════════════════════════════════════════════════════════════════════════
# 2. OUTLIER DETECTION USING MULTIPLE METHODS
# ══════════════════════════════════════════════════════════════════════════

print("\n" + "="*80)
print("OUTLIER DETECTION METHODS")
print("="*80)

# We'll look at UBC in both regions combined to find slides with consistently low UBC
all_ubc = pd.concat([df['Cortex_UBC'], df['Striatum_UBC']])

# Method 1: Tukey's method (IQR-based)
Q1 = all_ubc.quantile(0.25)
Q3 = all_ubc.quantile(0.75)
IQR = Q3 - Q1
tukey_lower = Q1 - 3.0 * IQR  # Using 3.0 IQR (extreme outliers)
tukey_upper = Q3 + 3.0 * IQR

print(f"\n1. Tukey's Method (3.0 × IQR for extreme outliers):")
print(f"   Q1 = {Q1:.2f}, Q3 = {Q3:.2f}, IQR = {IQR:.2f}")
print(f"   Lower fence: {tukey_lower:.2f}")
print(f"   Upper fence: {tukey_upper:.2f}")

# Method 2: Z-score (modified for robustness using median and MAD)
median_ubc = all_ubc.median()
mad_ubc = stats.median_abs_deviation(all_ubc)
z_threshold = 3.5  # Conservative threshold

print(f"\n2. Modified Z-score (MAD-based):")
print(f"   Median = {median_ubc:.2f}")
print(f"   MAD = {mad_ubc:.2f}")
print(f"   Threshold: |z| > {z_threshold}")

# Method 3: Percentile-based (slides below 1st percentile in BOTH regions)
percentile_1 = all_ubc.quantile(0.01)
percentile_5 = all_ubc.quantile(0.05)

print(f"\n3. Percentile-based:")
print(f"   1st percentile: {percentile_1:.2f}")
print(f"   5th percentile: {percentile_5:.2f}")

# ══════════════════════════════════════════════════════════════════════════
# 3. IDENTIFY OUTLIER SLIDES
# ══════════════════════════════════════════════════════════════════════════

print("\n" + "="*80)
print("IDENTIFYING OUTLIER SLIDES")
print("="*80)

# Define biological thresholds for UBC (high-expression housekeeping gene)
# Based on literature, UBC should be 30-150 mRNA/cell in healthy tissue
# Values < 10 mRNA/cell indicate technical failure
BIOLOGICAL_THRESHOLD_UBC = 10.0  # mRNA/cell

# Define slides as outliers if:
# 1. EITHER region shows UBC below biological threshold (< 10 mRNA/cell)
# 2. OR BOTH regions below 5th percentile (catches bilateral technical failures)
# 3. OR extreme z-scores in both regions

outlier_slides = []
outlier_reasons = []

for idx, row in df.iterrows():
    slide = row['slide']
    cortex_ubc = row['Cortex_UBC']
    striatum_ubc = row['Striatum_UBC']
    avg_ubc = (cortex_ubc + striatum_ubc) / 2

    # Calculate modified z-scores for each region
    z_cortex = (cortex_ubc - median_ubc) / (mad_ubc * 1.4826)  # 1.4826 is scaling factor
    z_striatum = (striatum_ubc - median_ubc) / (mad_ubc * 1.4826)

    reasons = []
    is_outlier = False

    # Criterion 1: EITHER region below biological threshold (most stringent)
    if cortex_ubc < BIOLOGICAL_THRESHOLD_UBC or striatum_ubc < BIOLOGICAL_THRESHOLD_UBC:
        reasons.append(f"UBC < {BIOLOGICAL_THRESHOLD_UBC} mRNA/cell (technical failure)")
        is_outlier = True

    # Criterion 2: BOTH regions below 5th percentile
    if cortex_ubc < percentile_5 and striatum_ubc < percentile_5:
        reasons.append(f"Both regions < 5th percentile ({percentile_5:.2f})")
        is_outlier = True

    # Criterion 3: Both regions have extreme z-scores
    if z_cortex < -z_threshold and z_striatum < -z_threshold:
        reasons.append(f"Both regions have |z| > {z_threshold}")
        is_outlier = True

    if is_outlier:
        outlier_slides.append(slide)
        outlier_reasons.append("; ".join(reasons))
        print(f"\n⚠ OUTLIER DETECTED: {slide}")
        print(f"   Cortex UBC: {cortex_ubc:.3f} mRNA/cell (z = {z_cortex:.2f})")
        print(f"   Striatum UBC: {striatum_ubc:.3f} mRNA/cell (z = {z_striatum:.2f})")
        print(f"   Average: {avg_ubc:.3f} mRNA/cell")
        print(f"   Reasons: {reasons}")

# Create outlier dataframe
df_outliers = df[df['slide'].isin(outlier_slides)].copy()
df_outliers['outlier_reasons'] = outlier_reasons

print(f"\n{'='*80}")
print(f"SUMMARY: {len(outlier_slides)} outlier slides identified")
print(f"{'='*80}")
for slide in outlier_slides:
    print(f"  - {slide}")

# ══════════════════════════════════════════════════════════════════════════
# 4. CREATE COMPREHENSIVE VISUALIZATION
# ══════════════════════════════════════════════════════════════════════════

print("\n" + "="*80)
print("Creating outlier visualization...")
print("="*80)

fig = plt.figure(figsize=(18, 12), dpi=300)
gs = fig.add_gridspec(3, 3, hspace=0.35, wspace=0.30,
                     left=0.07, right=0.98, top=0.95, bottom=0.06)

# ══════════════════════════════════════════════════════════════════════════
# Panel A: POLR2A vs UBC scatter (like original Panel A, but highlight outliers)
# ══════════════════════════════════════════════════════════════════════════

ax_a = fig.add_subplot(gs[0, :])

# Prepare data for plotting (combine Cortex and Striatum from each slide)
plot_data = []
for idx, row in df.iterrows():
    slide = row['slide']
    is_outlier = slide in outlier_slides

    # Cortex point
    plot_data.append({
        'slide': slide,
        'region': 'Cortex',
        'POLR2A': row['Cortex_POLR2A'],
        'UBC': row['Cortex_UBC'],
        'is_outlier': is_outlier
    })

    # Striatum point
    plot_data.append({
        'slide': slide,
        'region': 'Striatum',
        'POLR2A': row['Striatum_POLR2A'],
        'UBC': row['Striatum_UBC'],
        'is_outlier': is_outlier
    })

df_plot = pd.DataFrame(plot_data)

# Plot normal samples
df_normal = df_plot[~df_plot['is_outlier']]
for region in ['Cortex', 'Striatum']:
    region_data = df_normal[df_normal['region'] == region]
    color = 'blue' if region == 'Cortex' else 'red'
    marker = 'o' if region == 'Cortex' else 's'
    ax_a.scatter(region_data['POLR2A'], region_data['UBC'],
               c=color, s=80, alpha=0.6, edgecolor='black', linewidth=0.7,
               label=f'{region} (normal)', marker=marker, zorder=2)

# Plot outliers with special styling
df_outlier_plot = df_plot[df_plot['is_outlier']]
for region in ['Cortex', 'Striatum']:
    region_data = df_outlier_plot[df_outlier_plot['region'] == region]
    marker = 'o' if region == 'Cortex' else 's'
    ax_a.scatter(region_data['POLR2A'], region_data['UBC'],
               c='yellow', s=200, alpha=1.0, edgecolor='red', linewidth=3,
               label=f'{region} (OUTLIER)' if region == 'Cortex' else None,
               marker=marker, zorder=10)

    # Add slide labels for outliers
    for idx, row_data in region_data.iterrows():
        ax_a.annotate(row_data['slide'],
                     (row_data['POLR2A'], row_data['UBC']),
                     xytext=(10, 10), textcoords='offset points',
                     fontsize=9, fontweight='bold', color='red',
                     bbox=dict(boxstyle='round,pad=0.3', facecolor='yellow', alpha=0.8),
                     arrowprops=dict(arrowstyle='->', color='red', lw=1.5),
                     zorder=11)

# Add unity line
polr2a_max = df_plot['POLR2A'].max() * 1.1
ubc_max = df_plot['UBC'].max()
max_lim = max(polr2a_max, ubc_max * 1.05)
ax_a.plot([0, max_lim], [0, max_lim], 'k--', lw=1.5, alpha=0.5, label='Unity', zorder=1)

ax_a.set_xlim(0, polr2a_max)
ax_a.set_xlabel("POLR2A Expression [mRNA/cell]", fontsize=12, fontweight='bold')
ax_a.set_ylabel("UBC Expression [mRNA/cell]", fontsize=12, fontweight='bold')
ax_a.set_title("A. UBC Outlier Detection: POLR2A vs UBC Expression",
              fontsize=14, fontweight='bold', loc='left')
ax_a.legend(loc='upper left', fontsize=9, ncol=2)
ax_a.grid(True, alpha=0.3, linestyle='--')

# Add text box with outlier summary
outlier_text = f"OUTLIERS DETECTED: {len(outlier_slides)} slides\n"
outlier_text += "\n".join([f"• {slide}" for slide in outlier_slides])
ax_a.text(0.98, 0.97, outlier_text,
         transform=ax_a.transAxes, ha='right', va='top', fontsize=10,
         bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.9, edgecolor='red', linewidth=2))

# ══════════════════════════════════════════════════════════════════════════
# Panel B: Box plots for UBC by region with outliers marked
# ══════════════════════════════════════════════════════════════════════════

ax_b = fig.add_subplot(gs[1, 0])

# Prepare data
cortex_normal = df[~df['slide'].isin(outlier_slides)]['Cortex_UBC'].values
striatum_normal = df[~df['slide'].isin(outlier_slides)]['Striatum_UBC'].values
cortex_outlier = df[df['slide'].isin(outlier_slides)]['Cortex_UBC'].values
striatum_outlier = df[df['slide'].isin(outlier_slides)]['Striatum_UBC'].values

# Box plots
bp = ax_b.boxplot([cortex_normal, striatum_normal], positions=[1, 2],
                  widths=0.6, patch_artist=True,
                  boxprops=dict(facecolor='lightgreen', alpha=0.7),
                  medianprops=dict(color='darkgreen', linewidth=2),
                  showfliers=False)  # Don't show default outliers

# Color boxes
bp['boxes'][0].set_facecolor('lightblue')
bp['boxes'][1].set_facecolor('lightcoral')

# Add outlier points manually
ax_b.scatter([1]*len(cortex_outlier), cortex_outlier,
           s=200, c='yellow', edgecolor='red', linewidth=3, zorder=10,
           marker='o', label='Outliers')
ax_b.scatter([2]*len(striatum_outlier), striatum_outlier,
           s=200, c='yellow', edgecolor='red', linewidth=3, zorder=10,
           marker='s')

# Add threshold lines
ax_b.axhline(BIOLOGICAL_THRESHOLD_UBC, color='red', linestyle='-', linewidth=2.5,
            alpha=0.8, label=f'Biological threshold ({BIOLOGICAL_THRESHOLD_UBC:.0f} mRNA/cell)')
ax_b.axhline(percentile_5, color='orange', linestyle='--', linewidth=2,
            alpha=0.6, label=f'5th percentile ({percentile_5:.1f})')

ax_b.set_xticks([1, 2])
ax_b.set_xticklabels(['Cortex', 'Striatum'], fontsize=11)
ax_b.set_ylabel("UBC Expression [mRNA/cell]", fontsize=12, fontweight='bold')
ax_b.set_title("B. UBC Distribution by Region", fontsize=13, fontweight='bold', loc='left')
ax_b.legend(loc='upper right', fontsize=9)
ax_b.grid(True, alpha=0.3, linestyle='--', axis='y')

# ══════════════════════════════════════════════════════════════════════════
# Panel C: Bar chart showing average UBC per slide (sorted)
# ══════════════════════════════════════════════════════════════════════════

ax_c = fig.add_subplot(gs[1, 1:])

# Calculate average UBC per slide
df['avg_UBC'] = (df['Cortex_UBC'] + df['Striatum_UBC']) / 2
df_sorted = df.sort_values('avg_UBC')

# Create colors array
colors = ['red' if slide in outlier_slides else 'steelblue'
         for slide in df_sorted['slide']]

bars = ax_c.barh(range(len(df_sorted)), df_sorted['avg_UBC'],
                color=colors, edgecolor='black', linewidth=0.8, alpha=0.8)

# Add threshold lines
ax_c.axvline(BIOLOGICAL_THRESHOLD_UBC, color='red', linestyle='-', linewidth=2.5,
            alpha=0.8, label=f'Biological threshold ({BIOLOGICAL_THRESHOLD_UBC:.0f})')
ax_c.axvline(percentile_5, color='orange', linestyle='--', linewidth=2,
            alpha=0.6, label=f'5th percentile ({percentile_5:.1f})')

ax_c.set_yticks(range(len(df_sorted)))
ax_c.set_yticklabels(df_sorted['slide'], fontsize=8)
ax_c.set_xlabel("Average UBC Expression [mRNA/cell]", fontsize=12, fontweight='bold')
ax_c.set_ylabel("Slide ID", fontsize=12, fontweight='bold')
ax_c.set_title("C. Average UBC Expression per Slide (sorted)",
              fontsize=13, fontweight='bold', loc='left')
ax_c.legend(loc='lower right', fontsize=9)
ax_c.grid(True, alpha=0.3, linestyle='--', axis='x')

# Highlight outlier slide names in red
for i, (idx, row) in enumerate(df_sorted.iterrows()):
    if row['slide'] in outlier_slides:
        ax_c.get_yticklabels()[i].set_color('red')
        ax_c.get_yticklabels()[i].set_weight('bold')
        ax_c.get_yticklabels()[i].set_fontsize(10)

# ══════════════════════════════════════════════════════════════════════════
# Panel D: Histogram of UBC distribution with outlier threshold
# ══════════════════════════════════════════════════════════════════════════

ax_d = fig.add_subplot(gs[2, 0])

# All UBC values
all_ubc_values = pd.concat([df['Cortex_UBC'], df['Striatum_UBC']])
normal_ubc = all_ubc_values[~all_ubc_values.index.map(
    lambda x: df.iloc[x % len(df)]['slide'] in outlier_slides
)]
outlier_ubc = all_ubc_values[all_ubc_values.index.map(
    lambda x: df.iloc[x % len(df)]['slide'] in outlier_slides
)]

bins = np.linspace(0, all_ubc_values.max(), 40)
ax_d.hist(normal_ubc, bins=bins, alpha=0.7, color='steelblue',
         edgecolor='black', linewidth=0.8, label='Normal')
ax_d.hist(outlier_ubc, bins=bins, alpha=0.9, color='red',
         edgecolor='black', linewidth=1.2, label='Outliers')

# Add threshold lines
ax_d.axvline(BIOLOGICAL_THRESHOLD_UBC, color='red', linestyle='-', linewidth=2.5,
            alpha=0.8, label=f'Biological threshold ({BIOLOGICAL_THRESHOLD_UBC:.0f})')
ax_d.axvline(percentile_5, color='orange', linestyle='--', linewidth=2,
            alpha=0.6, label=f'5th %ile ({percentile_5:.2f})')
ax_d.axvline(percentile_1, color='purple', linestyle=':', linewidth=2,
            alpha=0.5, label=f'1st %ile ({percentile_1:.2f})')

ax_d.set_xlabel("UBC Expression [mRNA/cell]", fontsize=12, fontweight='bold')
ax_d.set_ylabel("Count", fontsize=12, fontweight='bold')
ax_d.set_title("D. UBC Expression Distribution", fontsize=13, fontweight='bold', loc='left')
ax_d.legend(loc='upper right', fontsize=9)
ax_d.grid(True, alpha=0.3, linestyle='--', axis='y')

# ══════════════════════════════════════════════════════════════════════════
# Panel E: POLR2A vs UBC ratio comparison (with/without outliers)
# ══════════════════════════════════════════════════════════════════════════

ax_e = fig.add_subplot(gs[2, 1])

# Calculate ratios
df['ratio_avg'] = (df['ratio_Cortex'] + df['ratio_Striatum']) / 2
ratio_normal = df[~df['slide'].isin(outlier_slides)]['ratio_avg']
ratio_outlier = df[df['slide'].isin(outlier_slides)]['ratio_avg']

bp_ratio = ax_e.boxplot([ratio_normal, ratio_outlier],
                        positions=[1, 2], widths=0.5,
                        patch_artist=True,
                        medianprops=dict(color='darkblue', linewidth=2))

bp_ratio['boxes'][0].set_facecolor('lightgreen')
bp_ratio['boxes'][1].set_facecolor('lightcoral')

# Add individual points
ax_e.scatter([1]*len(ratio_normal), ratio_normal,
           s=80, c='steelblue', alpha=0.6, edgecolor='black', linewidth=0.7,
           zorder=3)
ax_e.scatter([2]*len(ratio_outlier), ratio_outlier,
           s=150, c='red', alpha=0.8, edgecolor='black', linewidth=1.5,
           zorder=3)

ax_e.set_xticks([1, 2])
ax_e.set_xticklabels(['Normal slides', 'Outlier slides'], fontsize=11)
ax_e.set_ylabel("UBC / POLR2A Ratio", fontsize=12, fontweight='bold')
ax_e.set_title("E. Impact on UBC/POLR2A Ratio", fontsize=13, fontweight='bold', loc='left')
ax_e.grid(True, alpha=0.3, linestyle='--', axis='y')

# Add statistics
mean_normal = ratio_normal.mean()
mean_outlier = ratio_outlier.mean()
ax_e.text(0.98, 0.97,
         f"Normal: {mean_normal:.1f} ± {ratio_normal.std():.1f}\n"
         f"Outlier: {mean_outlier:.1f} ± {ratio_outlier.std():.1f}",
         transform=ax_e.transAxes, ha='right', va='top', fontsize=10,
         bbox=dict(boxstyle='round', facecolor='white', alpha=0.8))

# ══════════════════════════════════════════════════════════════════════════
# Panel F: Summary statistics table
# ══════════════════════════════════════════════════════════════════════════

ax_f = fig.add_subplot(gs[2, 2])
ax_f.axis('off')

# Calculate statistics
stats_data = []

# UBC statistics
ubc_all_normal = pd.concat([
    df[~df['slide'].isin(outlier_slides)]['Cortex_UBC'],
    df[~df['slide'].isin(outlier_slides)]['Striatum_UBC']
])
ubc_all_with_outliers = pd.concat([df['Cortex_UBC'], df['Striatum_UBC']])

stats_data.append(['Metric', 'All Data', 'Excl. Outliers'])
stats_data.append(['─'*20, '─'*15, '─'*15])
stats_data.append([
    'UBC mean ± SD',
    f'{ubc_all_with_outliers.mean():.1f} ± {ubc_all_with_outliers.std():.1f}',
    f'{ubc_all_normal.mean():.1f} ± {ubc_all_normal.std():.1f}'
])
stats_data.append([
    'UBC median',
    f'{ubc_all_with_outliers.median():.1f}',
    f'{ubc_all_normal.median():.1f}'
])
stats_data.append([
    'UBC CV (%)',
    f'{(ubc_all_with_outliers.std()/ubc_all_with_outliers.mean()*100):.1f}%',
    f'{(ubc_all_normal.std()/ubc_all_normal.mean()*100):.1f}%'
])
stats_data.append(['─'*20, '─'*15, '─'*15])
stats_data.append([
    'Ratio mean ± SD',
    f'{df["ratio_avg"].mean():.1f} ± {df["ratio_avg"].std():.1f}',
    f'{ratio_normal.mean():.1f} ± {ratio_normal.std():.1f}'
])
stats_data.append([
    'Ratio CV (%)',
    f'{(df["ratio_avg"].std()/df["ratio_avg"].mean()*100):.1f}%',
    f'{(ratio_normal.std()/ratio_normal.mean()*100):.1f}%'
])
stats_data.append(['─'*20, '─'*15, '─'*15])
stats_data.append([
    'N slides',
    f'{len(df)}',
    f'{len(df) - len(outlier_slides)}'
])

# Create table
table = ax_f.table(cellText=stats_data, cellLoc='left',
                  loc='center', bbox=[0, 0, 1, 1])
table.auto_set_font_size(False)
table.set_fontsize(9)
table.scale(1, 2.5)

# Style header row
for i in range(3):
    table[(0, i)].set_facecolor('#4CAF50')
    table[(0, i)].set_text_props(weight='bold', color='white')

# Style separator rows
for row_idx in [1, 5, 9]:
    for col_idx in range(3):
        table[(row_idx, col_idx)].set_facecolor('#f0f0f0')

ax_f.set_title("F. Statistical Summary", fontsize=13, fontweight='bold',
              loc='left', pad=20)

# ══════════════════════════════════════════════════════════════════════════
# SAVE FIGURE
# ══════════════════════════════════════════════════════════════════════════

fig_path = output_dir / "ubc_outlier_detection.png"
plt.savefig(fig_path, format='png', bbox_inches='tight', dpi=300)
print(f"\n✓ Figure saved: {fig_path}")

fig_path_pdf = output_dir / "ubc_outlier_detection.pdf"
plt.savefig(fig_path_pdf, format='pdf', bbox_inches='tight', dpi=300)
print(f"✓ Figure saved: {fig_path_pdf}")

plt.close(fig)

# ══════════════════════════════════════════════════════════════════════════
# 5. SAVE OUTLIER REPORT
# ══════════════════════════════════════════════════════════════════════════

print("\n" + "="*80)
print("Saving outlier report...")
print("="*80)

# Save outlier slides to CSV
outlier_report = df[df['slide'].isin(outlier_slides)][
    ['slide', 'Cortex_UBC', 'Striatum_UBC', 'Cortex_POLR2A', 'Striatum_POLR2A',
     'age', 'atlas_coord']
].copy()
outlier_report['avg_UBC'] = (outlier_report['Cortex_UBC'] + outlier_report['Striatum_UBC']) / 2
outlier_report['outlier_reasons'] = outlier_reasons
outlier_report = outlier_report.sort_values('avg_UBC')

csv_path = output_dir / "outlier_slides_to_exclude.csv"
outlier_report.to_csv(csv_path, index=False)
print(f"✓ Outlier report saved: {csv_path}")

# Save recommended exclusion list
exclusion_list_path = output_dir / "recommended_exclusion_list.txt"
with open(exclusion_list_path, 'w') as f:
    f.write("RECOMMENDED SLIDES TO EXCLUDE FROM ANALYSIS\n")
    f.write("=" * 60 + "\n\n")
    f.write(f"Total outlier slides identified: {len(outlier_slides)}\n\n")
    f.write("Slide IDs:\n")
    for slide in outlier_slides:
        f.write(f"  - {slide}\n")
    f.write("\n" + "=" * 60 + "\n")
    f.write("JUSTIFICATION:\n")
    f.write("=" * 60 + "\n\n")
    f.write("These slides show abnormally low UBC expression in BOTH Cortex and Striatum.\n")
    f.write("UBC is a high-expression housekeeping gene that should show consistent strong signal.\n")
    f.write("Such extreme low values (100-1000× below normal) indicate technical failures:\n")
    f.write("  • Poor probe hybridization\n")
    f.write("  • Tissue damage or degradation\n")
    f.write("  • Processing artifacts\n")
    f.write("  • Incomplete tissue coverage in imaging FOV\n\n")
    f.write("Including these slides would:\n")
    f.write("  1. Artificially inflate variance in expression measurements\n")
    f.write("  2. Bias mean expression estimates downward\n")
    f.write("  3. Obscure true biological signal\n")
    f.write("  4. Compromise statistical power\n\n")
    f.write("RECOMMENDATION: Exclude these slides from all downstream analyses.\n")

print(f"✓ Exclusion list saved: {exclusion_list_path}")

# Print summary
print("\n" + "="*80)
print("FINAL SUMMARY")
print("="*80)
print(f"\nTotal slides analyzed: {len(df)}")
print(f"Outliers detected: {len(outlier_slides)}")
print(f"Clean slides remaining: {len(df) - len(outlier_slides)}")
print(f"\nOutlier slides to exclude:")
for slide in outlier_slides:
    cortex_ubc = df[df['slide'] == slide]['Cortex_UBC'].values[0]
    striatum_ubc = df[df['slide'] == slide]['Striatum_UBC'].values[0]
    print(f"  • {slide:8s}  Cortex UBC: {cortex_ubc:7.3f}  Striatum UBC: {striatum_ubc:7.3f}")

print(f"\n{'='*80}")
print("ANALYSIS COMPLETE")
print(f"{'='*80}")
print(f"\nFiles saved to: {output_dir}")
print("  - ubc_outlier_detection.png (comprehensive visualization)")
print("  - ubc_outlier_detection.pdf (publication quality)")
print("  - outlier_slides_to_exclude.csv (detailed data)")
print("  - recommended_exclusion_list.txt (exclusion justification)")
